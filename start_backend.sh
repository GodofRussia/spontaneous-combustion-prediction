#!/bin/bash

# ะกะบัะธะฟั ะทะฐะฟััะบะฐ FastAPI backend
# ะัะฟะพะปัะทะพะฒะฐะฝะธะต: ./start_backend.sh

set -e

echo "๐ ะะฐะฟััะบ Coal Fire Prediction Backend..."
echo ""

# ะัะพะฒะตัะบะฐ Python
if ! command -v python3 &> /dev/null; then
    echo "โ Python 3 ะฝะต ะฝะฐะนะดะตะฝ. ะฃััะฐะฝะพะฒะธัะต Python 3.9 ะธะปะธ ะฒััะต."
    exit 1
fi

# ะะตัะตัะพะด ะฒ ะดะธัะตะบัะพัะธั backend
cd "$(dirname "$0")/backend"

# ะัะพะฒะตัะบะฐ ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั
if [ ! -d "venv" ]; then
    echo "๐ฆ ะกะพะทะดะฐะฝะธะต ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั..."
    python3 -m venv venv
fi

# ะะบัะธะฒะฐัะธั ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั
echo "๐ง ะะบัะธะฒะฐัะธั ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั..."
source venv/bin/activate

# ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
echo "๐ฅ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน..."
pip install -q --upgrade pip
pip install -q -r requirements.txt

# ะัะพะฒะตัะบะฐ ะผะพะดะตะปะธ
if [ ! -f "../models/fire_prediction_model.pkl" ]; then
    echo "โ๏ธ  ะัะตะดัะฟัะตะถะดะตะฝะธะต: ะคะฐะนะป ะผะพะดะตะปะธ ะฝะต ะฝะฐะนะดะตะฝ!"
    echo "   ะััั: ../models/fire_prediction_model.pkl"
    echo "   ะกะธััะตะผะฐ ะผะพะถะตั ัะฐะฑะพัะฐัั ะฝะตะบะพััะตะบัะฝะพ."
    echo ""
fi

# ะะฐะฟััะบ ัะตัะฒะตัะฐ
echo "โ ะะฐะฟััะบ FastAPI ัะตัะฒะตัะฐ..."
echo ""
echo "๐ Backend ะดะพัััะฟะตะฝ ะฟะพ ะฐะดัะตัั: http://localhost:8000"
echo "๐ API ะดะพะบัะผะตะฝัะฐัะธั: http://localhost:8000/docs"
echo "๐ ReDoc: http://localhost:8000/redoc"
echo ""
echo "ะะฐะถะผะธัะต Ctrl+C ะดะปั ะพััะฐะฝะพะฒะบะธ ัะตัะฒะตัะฐ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

uvicorn main:app --reload --host 0.0.0.0 --port 8000